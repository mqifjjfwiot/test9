<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<!-- namespace속성:매퍼파일의 완전한경로 .xml는 생략 -->
<!-- ※ibatis와는 다르게 id값에 .(dot)를 사용 못한다. -->
<mapper namespace="onememo.mybatis.mapper.test">
	<!-- 멤버 관련 쿼리 -->
	<insert id="myInsert" parameterType="testDTO">
		INSERT INTO MEMBER VALUES(no.nextval,#{id},#{pwd},#{name},#{addr},#{tel},#{mail},default)
	</insert>
	
	
	<!-- 
		CREATE TABLE MEMBER
(
	NO number NOT NULL,
	ID varchar2(15) NOT NULL,
	MNO number DEFAULT 0,
	PWD nvarchar2(20) NOT NULL,
	NAME nvarchar2(20) NOT NULL,
	ADDR varchar2(100) NOT NULL,
	TEL varchar2(13) NOT NULL,
	MALE varchar2(50) NOT NULL,
	BIRTH date DEFAULT SYSDATE,
	PRIMARY KEY (ID)
);
	 -->
	<select id="myMemberCnt" resultType="int" parameterType="testDTO">
		SELECT COUNT(*) FROM member WHERE id=#{id}
	</select>
	<select id="selectMyMemberInfo" resultType="testDTO" parameterType="testDTO">
		SELECT * FROM member WHERE id=#{id}
	</select>
	<update id="memberUpdate" parameterType="testDTO">
		UPDATE member SET pwd = #{pwd} , name = #{name} , addr = #{addr} , tel = #{tel}, mail = #{mail}
		WHERE id = #{id}	
	</update>
	
	<!-- 게시판 관련 쿼리 -->
	<select id="memoIsLogin" parameterType="Map" resultType="int">
		SELECT COUNT(*) FROM member WHERE id=#{id} AND pwd=#{pwd}		
	</select>
	<select id="memoTotalCount" parameterType="Map" resultType="int">
		SELECT COUNT(*) FROM board b JOIN member m ON b.id=m.id
		<if test="searchWord !=null">
			WHERE ${searchColumn} LIKE '%' || #{searchWord} || '%'
		</if>		
	</select>
	
	<select id="memoSelectList" parameterType="Map" resultType="testDTO">
		SELECT * FROM
		(SELECT T.*,ROWNUM R FROM (SELECT b.*,m.name,(SELECT COUNT(*) FROM linecomments WHERE lno=b.bono) as commentcount FROM
		member m JOIN board b ON m.id= b.id
		<if test="searchWord !=null">
			WHERE ${searchColumn} LIKE '%' || #{searchWord} || '%'
		</if>
		
		ORDER BY bono DESC) T)
		WHERE R BETWEEN #{start} AND #{end}	
	</select>
	<insert id="memoInsert" parameterType="Map">
		INSERT INTO BOARD 
		VALUES(SEQ_BOARD.NEXTVAL,#{id},#{title},#{CATEGORY},#{BCOUNT},#{bcontent},DEFAULT)
	</insert>
	<!-- 
	BONO number NOT NULL,
	ID varchar2(15) NOT NULL,
	TITLE varchar2(20) NOT NULL,
	CATEGORY varchar2(50) DEFAULT '' NOT NULL,
	BCOUNT nvarchar2(200) DEFAULT '' NOT NULL,
	BCONTENT nvarchar2(200) NOT NULL,
	postDate date DEFAULT SYSDATE,
	PRIMARY KEY (BONO)
	 -->
	
	<select id="memoSelectOne" resultType="testDTO" parameterType="Map">
		SELECT b.*,m.name FROM
		member m JOIN board b ON m.id= b.id
		WHERE bono = #{bono}
	</select>
	<delete id="memoDelete" parameterType="Map">
		DELETE board WHERE bono=#{bono}
	</delete>
	<update id="memoUpdate" parameterType="Map">
		UPDATE board SET title=#{title} , bcontent=#{bcontent}
		WHERE bono=#{bono}	
	</update>

	<!--  그 이외 쿼리 -->
	<delete id="itemsDelete" parameterType="Map">
		DELETE ITEMS WHERE INO=#{INO}
	</delete>
	
	<insert id="itemsInsert" parameterType="Map">
		INSERT INTO ITEMS 
		VALUES(SEQ_ITEMS.NEXTVAL,#{MNO},#{LNO},#{IMAGE},#{IMAGES2},#{INAME},#{INAME2},#{INAME3},
		,#{PRICE},#{IPAGE},#{IPAGE2},#{CATEORY},#{STOCK},#{HASHTAG},#{DISH},#{BRAND},#{PNO})
	</insert>
	
	
	<update id="itemsUpdate" parameterType="Map">
		UPDATE ITEMS SET IMAGE=#{IMAGE}, INAME = #{INAME}, INAME2=#{INAME2}, PRICE=#{PRICE}
		WHERE CATEGORY=#{CATEGORY}	
	</update>
	<!--
	<select id="itemsSelectOne" resultMap="itemsDTOResult" parameterType="itemsDTO">
		SELECT * FROM ITEMS WHERE INO = #{INO}
	</select>
	 
	<select id="itemsShopping" resultMap="itemsDTOResult" parameterType="itemsDTO">
		SELECT i.* FROM
		BASKET b JOIN ITEMS i ON b.INO= i.INO
		WHERE BNO = #{BNO}
	</select>
	
	<insert id="BasketInsert" parameterType="BasketDTO">
		INSERT INTO ITEMS 
		VALUES(SEQ_ITEMS.NEXTVAL,#{MNO},#{LNO},#{IMAGE},#{IMAGES2},#{INAME},#{INAME2},#{INAME3},
		,#{PRICE},#{IPAGE},#{IPAGE2},#{CATEORY},#{STOCK},#{HASHTAG},#{DISH},#{BRAND},#{PNO})
	</insert>
	-->
	
	<resultMap type="Map" id="BasketDTOResult">
		<result column="id" property="id"/>
		<result column="ino" property="ino"/>
		<result column="iname" property="iname"/>
		<result column="iname2" property="iname2"/>
		<result column="price" property="price"/>
		<result column="category" property="category"/>
	</resultMap>
	
	<select id="BasketSelect" parameterType="Map" resultType="BasketDTO">
		SELECT m.id, i.ino, i.iname, i.iname2, i.price, i.category
		From basket b
		join ITEMs i
		on b.ino = i.ino
		join member m
		on b.id = m.id
		where b.id=#{id} and b.payment =0
	</select>
	
	<delete id="BasketDelete" parameterType="Map">
		DELETE FROM basket
		WHERE id=#{id} AND ino=#{ino}
	</delete>
	
	<insert id="BasketInsert" parameterType="Map">
		INSERT INTO basket (BNO,ID,INO,PAYMENT) 
		VALUES (SEQ_BASKET.nextval,#{id},#{ino},DEFAULT)
	</insert>
	
	<!-- 
		ALTER TABLE BASKET MODIFY (PAYMENT DEFAULT 0); 추가해야함
		장바구니에서 결제 완료시 BASKET 테이블에 PAYMENT (Default:0) 의 값이 1로 바뀜 
		PAYMENT 값이 0이면 장바구니에
		PAYMENT 값이 1이면 결제완료목록에 뿌려줄예정
	 -->
	<update id="CompletePayment" parameterType="Map">
		UPDATE basket
		SET payment = 1
		WHERE id=#{id}
	</update>
	
</mapper>